name: Android Build with AI Autofix

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3️⃣ Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 5️⃣ Setup Android SDK (for Gradle/AGP fixes)
      - name: Setup Android SDK
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          wget https://dl.google.com/android/repository/commandlinetools-linux-9123335_latest.zip -O cmdline-tools.zip
          mkdir -p $HOME/Android/cmdline-tools
          unzip cmdline-tools.zip -d $HOME/Android/cmdline-tools
          yes | $HOME/Android/cmdline-tools/cmdline-tools/bin/sdkmanager --licenses
          $HOME/Android/cmdline-tools/cmdline-tools/bin/sdkmanager "platform-tools" "platforms;android-33"

      # 6️⃣ Initial Gradle build
      - name: Build project
        id: gradle_build
        run: ./gradlew build
        continue-on-error: true

      # 7️⃣ Run AI autofix if build fails
      - name: Run AI Autofix
        if: steps.gradle_build.outcome == 'failure'
        run: python3 scripts/ai_autofix.py

      # 8️⃣ Push AI fix branch & create PR
      - name: Create Pull Request for AI Fix
        if: steps.gradle_build.outcome == 'failure'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: AI autofix Gradle/AGP issues"
          branch: ai-autofix
          title: "AI Autofix: Build Failure Fix"
          body: |
            This PR was automatically generated by AI to fix Gradle/AGP build failures.
            It includes retries and only applies fixes that pass the build.
