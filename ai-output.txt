//===== FILE: modules/callhandler/src/main/kotlin/com/jarvismini/callhandler/accessibility/CallAccessibilityService.kt =====

package com.jarvismini.callhandler.accessibility

import android.accessibilityservice.AccessibilityService
import android.view.accessibility.AccessibilityEvent
import android.content.Intent
import android.util.Log
import com.jarvismini.callhandler.service.CallAutoReplyService
import com.jarvismini.automation.orchestrator.AutoReplyOrchestrator
import com.jarvismini.automation.input.AutoReplyInput
import com.jarvismini.automation.decision.ReplyDecision
import com.jarvismini.core.JarvisMode
import com.jarvismini.core.JarvisState

class CallAccessibilityService : AccessibilityService() {

    override fun onAccessibilityEvent(event: AccessibilityEvent?) {
        if (event == null) return

        if (
            event.eventType != AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED &&
            event.eventType != AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED
        ) return

        val text = event.text?.joinToString(" ") ?: return

        if (
            !text.contains("incoming", ignoreCase = true) &&
            !text.contains("calling", ignoreCase = true)
        ) return

        Log.d("CALL-A11Y", "Call UI detected: $text")

        if (JarvisState.currentMode == JarvisMode.NORMAL) {
            Log.d("CALL-A11Y", "Jarvis NORMAL â†’ ignore")
            return
        }

        val number = extractPhoneNumber(text)
        if (number.isNullOrBlank()) {
            Log.d("CALL-A11Y", "No number detected")
            return
        }

        val decision = AutoReplyOrchestrator.handle(
            AutoReplyInput(
                messageText = "Incoming call",
                isFromOwner = false
            )
        )

        if (decision !is ReplyDecision.AutoReply) {
            Log.d("CALL-A11Y", "No auto-reply decision")
            return
        }

        val intent = Intent(
            applicationContext,
            CallAutoReplyService::class.java
        ).apply {
            putExtra(CallAutoReplyService.EXTRA_NUMBER, number)
            putExtra(CallAutoReplyService.EXTRA_MESSAGE, decision.message)
        }

        startForegroundService(intent)
    }

    override fun onInterrupt() {
        // no-op
    }

    private fun extractPhoneNumber(text: String): String? {
        val regex = Regex("(\\+?\\d{10,13})")
        return regex.find(text)?.value
    }
}
//===== FILE: app/src/main/res/xml/call_accessibility_config.xml =====

<accessibility-service
    xmlns:android="http://schemas.android.com/apk/res/android"
    android:accessibilityEventTypes="typeWindowStateChanged|typeWindowContentChanged"
    android:accessibilityFeedbackType="feedbackGeneric"
    android:notificationTimeout="100"
    android:canRetrieveWindowContent="true"
    android:accessibilityFlags="flagReportViewIds"
    android:description="@string/accessibility_call_desc" />
    
